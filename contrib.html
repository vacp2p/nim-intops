<!DOCTYPE HTML>
<html lang="en-us" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using nimibook -->
        <meta charset="UTF-8">
        <title>Contributor's Guide - intops</title>

        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Integer arithmetics primitives.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üê≥</text></svg>">
        <link rel="stylesheet" href="./assets/css/variables.css">
        <link rel="stylesheet" href="./assets/css/general.css">
        <link rel="stylesheet" href="./assets/css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="./assets/FontAwesome/css/font-awesome.min.css">

        <!-- Highlight.js Stylesheets - I could use nimib native highlight but let's keep it for styling... -->
        <link rel="stylesheet" href="./assets/css/highlight.css">
        <link rel="stylesheet" href="./assets/css/tomorrow-night.css">
        <link rel="stylesheet" href="./assets/css/ayu-highlight.css">

        <!-- Custom theme stylesheets - why the "../"? -->


        

            <script src="https://cdn.jsdelivr.net/gh/pietroppeter/nimib@main/assets/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

        
        <!-- plausible analytics (new in nimibook) -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = ".//assets";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                                <ol class="chapter">
                <li class="chapter-item expanded ">
                  <a href="./index.html" tabindex="0">
                    <strong aria-hidden="true">1.</strong> Welcome to intops!
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./quickstart.html" tabindex="0">
                    <strong aria-hidden="true">2.</strong> Quickstart
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./contrib.html" class="active" tabindex="0">
                    <strong aria-hidden="true">3.</strong> Contributor's Guide
                  </a></li>
                  <li>
                  <ol class="section">
                <li class="chapter-item expanded ">
                  <a href="./contrib/ops.html" tabindex="0">
                    <strong aria-hidden="true">3.1.</strong> Operations
                  </a></li>
                <li class="chapter-item expanded ">
                  <a href="./contrib/impl.html" tabindex="0">
                    <strong aria-hidden="true">3.2.</strong> Implementations
                  </a></li>
                  </ol>
                  </li>
                <li class="chapter-item expanded ">
                  <a href="./changelog.html" tabindex="0">
                    <strong aria-hidden="true">4.</strong> Changelog
                  </a></li>
                </ol>
<!-- I could use also an unescaped context value -->
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">intops</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/vacp2p/nim-intops" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1>Contributor's Guide</h1>
<p>Optimizing arithmetic operations for a variety of enviroments and consumers is a never-ending chase. There hardly will ever be a moment when intops will be 100% ready: there's always an older Nim version, and newer GCC version, or an obscure CPU vendor to target.</p>
<p>Because of that, contributors' help is essential for intops' development. You can help improve intops by improving the code, improving the docs, and reporting issues.</p>
<h2>Library Structure</h2>
<pre><code class="language-shell">src
‚îÇ   intops.nim              &lt;- entrypoint for the public API
‚îÇ
‚îî‚îÄ‚îÄ‚îÄintops
    ‚îÇ   consts.nim          &lt;- global constants for environment detection
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄimpl                &lt;- implementations of primitives
    ‚îÇ   ‚îÇ   inlineasm.nim   &lt;- entrypoint for the Inline ASM family of implementations
    ‚îÇ   ‚îÇ   inlinec.nim
    ‚îÇ   ‚îÇ   intrinsics.nim
    ‚îÇ   ‚îÇ   pure.nim
    ‚îÇ   ‚îÇ   ...
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄinlineasm
    ‚îÇ   ‚îÇ       arm64.nim   &lt;- implementation in ARM64 Assembly 
    ‚îÇ   ‚îÇ       x86.nim
    ‚îÇ   ‚îÇ       ...
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ...
    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄops                 &lt;- operation families
            add.nim         &lt;- addition flavors: carrying, saturating, etc.
            mul.nim
            sub.nim
            ...
</code></pre>
<p>The entrypoint is the root <code>intops</code> module. It's the library's public API and exposes all the available primitives.</p>
<p>Each operation family has its own submodule in <code>intops/ops</code>. E.g. <code>intops/ops/add</code> is the submodule that contains various addition flavors.</p>
<p>These submodules contain the dispatchers that pick the best implementation of the given operation and for the given CPU, OS, and C compiler. I.e., each operation &quot;knows&quot; its best implementation and &quot;decides&quot; which one to run.</p>
<p>The actual implementations are stored in submodules in <code>intops/impl</code>. For example, <code>intops/impl/intrinsics</code> contains all primitives implemented with C intrinsics.</p>
<h2>API Conventions</h2>
<ol>
<li>intops follows the common Nim convention of calling things in <code>camelCase</code>.</li>
<li>intops prefers pure functions that return values to the ones that modify mutable arguments.</li>
<li>The docstrings are mandatory for the dispatchers in <code>intops/ops</code> modules because this is the library public API.</li>
<li>Operations the return a wider type that the input type are called <strong>widening</strong>. For example <code>wideningMul</code>¬†is multiplication that takes two 64-bit integers and return a single 128-bit integer (althouth represented as a pair of 64-bit integers).</li>
<li>Operations that return a carry or borrow flag are called <strong>carrying</strong> and <strong>borrowing</strong>, e.g. <code>carryingAdd</code>.</li>
<li>Operations that return an overflow flag are called <strong>overflowing</strong>, e.g. <code>overflowingSub</code>.</li>
<li>Operations that return maximal or mininal type value when a type border is hit are called <strong>saturating</strong>, e.g. <code>saturatingAdd</code>.</li>
<li>Carry, borrow, and overflow flags are booleans.</li>
</ol>
<h2>Tests</h2>
<p>The tests for intops are located in a single file <code>tests/tintops.nim</code>.</p>
<p>These are integration tests that emulate real-lfe usage of the library and check two things:</p>
<ol>
<li>every dispatcher picks the proper implementation on any environment</li>
<li>the results are correct no matter the implementation</li>
</ol>
<p>To run the tests locally, use <code>nimble test</code> command.</p>
<p>With this command, the tests are run:</p>
<ul>
<li>without compilation flags in runtime mode</li>
<li>without compilation flags in compile-time mode</li>
<li>with each compilation flag separately</li>
<li>with all compilation flags</li>
</ul>
<p>When executed on the CI, the tests are run against multiple OS, C compilers, and architectures:</p>
<ul>
<li>amd64 + Linux + gcc 13</li>
<li>amd64 + Linux + gcc 14</li>
<li>amd64 + Windows + clang 19</li>
<li>i386 + Linux + gcc 13</li>
<li>amd64 + macOS + clang 17</li>
<li>arm46 + macOS + clang 17</li>
</ul>
<p>This is hardly reproduceable locally, but you can cover at least some of the cases by passing flags to <code>nimble test</code>. For example, to emulate running the tests in a 32-bit CPU, run <code>nimble --cpu:i386 test</code>. On Windows, you also must pass the path to your GCC installation, e.g. <code>nimble --gcc.path:D:\mingw32\bin\ --cpu:i386 test</code>.
To run your tests contunously during development, use <a href="https://github.com/jiro4989/monit">monit</a>:</p>
<ol>
<li>Install monit with <code>nimble install monit</code>.</li>
<li>Create a file called .monit.yml in the working directory:</li>
</ol>
<pre><code class="language-yaml">%YAML 1.2
%TAG !n! tag:nimyaml.org,2016:
---
!n!custom:MonitorConfig
sleep: 1
targets:
  - name: Run tests
    paths: [src, tests]
    commands:
      - nimble test
      - nimble --gcc.path:D:\mingw32\bin\ --cpu:i386 test
    extensions: [.nim]
    files: []
    exclude_extensions: []
    exclude_files: []
    once: true
</code></pre>
<ol start="3">
<li>Run <code>monit run</code></li>
</ol>
<h2>Benchmarks</h2>
<p>Benchmarking is crucial for a library like intops: you can't really do any reasonable dispatching improvement if you can't argue about the changes with numbers.</p>
<p>There are two kinds of benchmarks: latency and throughput.</p>
<p><em>Latency benchmarks</em> measure how long a particular operation takes to complete. For a latency benchmark, we run the same operation against random input many times making sure the next iteration doesn't start before the previous one completes. The result is measured in nanoseconds per operation.</p>
<p><em>Throughput benchmarks</em> measure how many operations of a particluar kind can be executed per unit of time. For a throughput benchmark, we spawn the same operation against random input many times back to back so that multiple instances of the same operation are executed in parallel. The results are measured in millions of operations per second.</p>
<p>Benchmarks are grouped by kind and operation family, e.g. <code>benchmarks/latency/add.nim</code> contains latency benchmarks for the add operations (overflowingAdd, saturatingAdd, etc.).</p>
<p>To run the benchmarks locally, use <code>nimble bench</code> command:</p>
<ul>
<li>run latency and throughput benchmarks for all operations:</li>
</ul>
<pre><code>$ nimble bench
</code></pre>
<ul>
<li>run latency and throughput benchmarks for particular operations:</li>
</ul>
<pre><code>$ nimble bench add
$ nimble bench sub mul
</code></pre>
<ul>
<li>run latency or throughput benchmarks for all operations:</li>
</ul>
<pre><code>$ nimble bench --kind:latency
$ nimble bench --kind:throughput
</code></pre>
<ul>
<li>run particular kind of benchmarks on a particular kind of operations:</li>
</ul>
<pre><code>$ nimble bench --kind:latency add
$ nimble bench --kind:throughput sub mul
</code></pre>
<h2>Docs</h2>
<p>The docs consist of two parts:</p>
<ul>
<li>the book (this is what you're reading right now)</li>
<li>the API docs</li>
</ul>
<p>The book is created using <a href="https://github.com/pietroppeter/nimibook">nimibook</a>. Each page is a Nim file that can hold Markdown content and Nim code. The Nim code is executed during the build and its output are included in the book.</p>
<p>The API docs are generated from the source code docstrings.</p>
<p>To build the docs locally, run:</p>
<ul>
<li><code>nimble book</code>¬†to build the book</li>
<li><code>nimble apidocs</code> to build the API docs</li>
<li><code>nimble docs</code> to build both</li>
</ul>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="./quickstart.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="./contrib/ops.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="./quickstart.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="./contrib/ops.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>







        <script src="./assets/js/clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="./assets/js/book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
